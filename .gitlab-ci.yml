stages:
    - build

variables:
    DEBIAN_FRONTEND: noninteractive
    DEBEMAIL: Marco Giusti <marco.giusti3@studio.unibo.it>

.build-template: &build-deb
    stage: build
    before_script:
        - apt-get update
        # install download-secure-file to be able to access the secure files in .secure_files/
        - apt-get install -y curl gpg
        - curl --silent https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer | bash
        # Import the GnuPG key necessary to sign the changes file.
        - gpg --import .secure_files/public.key
        - gpg --import .secure_files/private.key
        # install the build dependencies
        - apt-get install -y build-essential debhelper devscripts dh-python python3-all python3-setuptools imagemagick
        - export VB_VERSION="$(python3 setup.py -V)"
        - export "VB_DEB_VERSION=${VB_VERSION}-0~${DISTRIBUTION}1"
        - mkdir dist
        - cp -R . ../virtualbricks-"$VB_VERSION"
        - cd ../virtualbricks-"$VB_VERSION"
    script:
        - debchange --newversion "$VB_DEB_VERSION" "New upstream version"
        - debchange --release --distribution "${DISTRIBUTION}" ""
        - dpkg-buildpackage
        - cp ../virtualbricks_"$VB_DEB_VERSION"* ../virtualbricks/dist/
    artifacts:
        paths:
            - dist/*

# Debian 10, buster, oldoldstable
debian-10:
    <<: *build-deb
    image: debian:buster
    variables:
      DISTRIBUTION: buster

# Debian 11, bullseye, oldstable
debian-11:
    <<: *build-deb
    image: debian:bullseye
    variables:
      DISTRIBUTION: bullseye

# Debian 12, bookworm, stable
debian-12:
    <<: *build-deb
    image: debian:bookworm
    variables:
      DISTRIBUTION: bookworm

# Debian 13, trixie, testing
debian-13:
    <<: *build-deb
    image: debian:trixie
    variables:
      DISTRIBUTION: trixie

# Debian unstable, sid
debian-sid:
    <<: *build-deb
    image: debian:sid
    variables:
      DISTRIBUTION: sid

# Ubuntu 20.04 LTS, focal
ubuntu-20.04:
    <<: *build-deb
    image: ubuntu:focal
    variables:
      DISTRIBUTION: focal

# Ubuntu 22.04 LTS, jammy
ubuntu-22.04:
    <<: *build-deb
    image: ubuntu:jammy
    variables:
      DISTRIBUTION: jammy

# Ubuntu 24.04 LTS, noble
ubuntu-24.04:
    <<: *build-deb
    image: ubuntu:noble
    variables:
      DISTRIBUTION: noble
